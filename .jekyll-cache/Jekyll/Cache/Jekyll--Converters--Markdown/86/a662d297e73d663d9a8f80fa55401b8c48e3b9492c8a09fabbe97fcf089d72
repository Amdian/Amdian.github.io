I"â=<ul id="markdown-toc">
  <li><a href="#redis-äº‹åŠ¡çš„åŸºæœ¬ä½¿ç”¨" id="markdown-toc-redis-äº‹åŠ¡çš„åŸºæœ¬ä½¿ç”¨">Redis äº‹åŠ¡çš„åŸºæœ¬ä½¿ç”¨</a></li>
  <li><a href="#åŸå­æ€§" id="markdown-toc-åŸå­æ€§">åŸå­æ€§</a></li>
  <li><a href="#discardä¸¢å¼ƒ" id="markdown-toc-discardä¸¢å¼ƒ">discardï¼ˆä¸¢å¼ƒï¼‰</a></li>
  <li><a href="#ä¼˜åŒ–" id="markdown-toc-ä¼˜åŒ–">ä¼˜åŒ–</a></li>
  <li><a href="#watch" id="markdown-toc-watch">Watch</a></li>
</ul>

<h4 id="redis-äº‹åŠ¡çš„åŸºæœ¬ä½¿ç”¨">Redis äº‹åŠ¡çš„åŸºæœ¬ä½¿ç”¨</h4>

<p>æ¯ä¸ªäº‹åŠ¡çš„æ“ä½œéƒ½æœ‰ beginã€commit å’Œ rollbackï¼Œbegin æŒ‡ç¤ºäº‹åŠ¡çš„å¼€å§‹ï¼Œcommit æŒ‡ç¤ºäº‹åŠ¡çš„æäº¤ï¼Œrollback æŒ‡ç¤ºäº‹åŠ¡çš„å›æ»šã€‚å®ƒå¤§è‡´çš„å½¢å¼å¦‚ä¸‹ã€‚</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">begin</span><span class="o">();</span>
<span class="k">try</span> <span class="o">{</span>
 <span class="n">command1</span><span class="o">();</span>
 <span class="n">command2</span><span class="o">();</span>
 <span class="o">....</span>
 <span class="n">commit</span><span class="o">();</span>
<span class="o">}</span> <span class="k">catch</span><span class="o">(</span><span class="nc">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
 <span class="n">rollback</span><span class="o">();</span>
<span class="o">}</span>
</code></pre></div></div>

<p>Redis åœ¨å½¢å¼ä¸Šçœ‹èµ·æ¥ä¹Ÿå·®ä¸å¤šï¼Œåˆ†åˆ«æ˜¯ multi/exec/discardã€‚multi æŒ‡ç¤ºäº‹åŠ¡çš„å¼€å§‹ï¼Œexec æŒ‡ç¤ºäº‹åŠ¡çš„æ‰§è¡Œï¼Œdiscard æŒ‡ç¤ºäº‹åŠ¡çš„ä¸¢å¼ƒã€‚</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">&gt;</span> <span class="n">multi</span>
<span class="no">OK</span>
<span class="o">&gt;</span> <span class="n">incr</span> <span class="n">books</span>
<span class="no">QUEUED</span>
<span class="o">&gt;</span> <span class="n">incr</span> <span class="n">books</span>
<span class="no">QUEUED</span>
<span class="o">&gt;</span> <span class="n">exec</span>
<span class="o">(</span><span class="n">integer</span><span class="o">)</span> <span class="mi">1</span>
</code></pre></div></div>

<p>ä¸Šé¢çš„æŒ‡ä»¤æ¼”ç¤ºäº†ä¸€ä¸ªå®Œæ•´çš„äº‹åŠ¡è¿‡ç¨‹ï¼Œæ‰€æœ‰çš„æŒ‡ä»¤åœ¨ exec ä¹‹å‰ä¸æ‰§è¡Œï¼Œè€Œæ˜¯ç¼“å­˜åœ¨æœåŠ¡å™¨çš„ä¸€ä¸ªäº‹åŠ¡é˜Ÿåˆ—ä¸­ï¼ŒæœåŠ¡å™¨ä¸€æ—¦æ”¶åˆ° exec æŒ‡ä»¤ï¼Œæ‰å¼€æ‰§è¡Œæ•´ä¸ªäº‹åŠ¡é˜Ÿåˆ—ï¼Œæ‰§è¡Œå®Œæ¯•åä¸€æ¬¡æ€§è¿”å›æ‰€æœ‰æŒ‡ä»¤çš„è¿è¡Œç»“æœã€‚å› ä¸º Redis çš„å•çº¿ç¨‹ç‰¹æ€§ï¼Œå®ƒä¸ç”¨æ‹…å¿ƒè‡ªå·±åœ¨æ‰§è¡Œé˜Ÿåˆ—çš„æ—¶å€™è¢«å…¶å®ƒæŒ‡ä»¤æ‰“æ…ï¼Œå¯ä»¥ä¿è¯ä»–ä»¬èƒ½å¾—åˆ°çš„ã€ŒåŸå­æ€§ã€æ‰§è¡Œã€‚</p>
<p>ä¸Šå›¾æ˜¾ç¤ºäº†ä»¥ä¸Šäº‹åŠ¡è¿‡ç¨‹å®Œæ•´çš„äº¤äº’æ•ˆæœã€‚QUEUED æ˜¯ä¸€ä¸ªç®€å•å­—ç¬¦ä¸²ï¼ŒåŒ OK æ˜¯ä¸€ä¸ªå½¢å¼ï¼Œå®ƒè¡¨ç¤ºæŒ‡ä»¤å·²ç»è¢«æœåŠ¡å™¨ç¼“å­˜åˆ°é˜Ÿåˆ—é‡Œäº†ã€‚</p>

<hr />

<h4 id="åŸå­æ€§">åŸå­æ€§</h4>

<p>äº‹åŠ¡çš„åŸå­æ€§æ˜¯æŒ‡è¦ä¹ˆäº‹åŠ¡å…¨éƒ¨æˆåŠŸï¼Œè¦ä¹ˆå…¨éƒ¨å¤±è´¥ï¼Œé‚£ä¹ˆRedis äº‹åŠ¡æ‰§è¡Œæ˜¯åŸå­æ€§çš„ä¹ˆï¼Ÿ</p>

<p>ä¸‹é¢æˆ‘ä»¬æ¥çœ‹ä¸€ä¸ªç‰¹åˆ«çš„ä¾‹å­ã€‚</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">&gt;</span> <span class="n">multi</span>
<span class="no">OK</span>
<span class="o">&gt;</span> <span class="n">set</span> <span class="n">books</span> <span class="n">iamastring</span>
<span class="no">QUEUED</span>
<span class="o">&gt;</span> <span class="n">incr</span> <span class="n">books</span>
<span class="no">QUEUED</span>
<span class="o">&gt;</span> <span class="n">set</span> <span class="n">poorman</span> <span class="n">iamdesperate</span>
<span class="no">QUEUED</span>
<span class="o">&gt;</span> <span class="n">exec</span>
<span class="mi">1</span><span class="o">)</span> <span class="no">OK</span>
<span class="mi">2</span><span class="o">)</span> <span class="o">(</span><span class="n">error</span><span class="o">)</span> <span class="no">ERR</span> <span class="n">value</span> <span class="n">is</span> <span class="n">not</span> <span class="n">an</span> <span class="n">integer</span> <span class="n">or</span> <span class="n">out</span> <span class="n">of</span> <span class="n">range</span>
<span class="mi">3</span><span class="o">)</span> <span class="no">OK</span>
<span class="o">&gt;</span> <span class="n">get</span> <span class="n">books</span>
<span class="s">"iamastring"</span>
<span class="o">&gt;</span> <span class="n">get</span> <span class="n">poorman</span>
<span class="err">"</span><span class="n">iamdesperate</span>
</code></pre></div></div>

<p>ä¸Šé¢çš„ä¾‹å­æ˜¯äº‹åŠ¡æ‰§è¡Œåˆ°ä¸­é—´é‡åˆ°å¤±è´¥äº†ï¼Œå› ä¸ºæˆ‘ä»¬ä¸èƒ½å¯¹ä¸€ä¸ªå­—ç¬¦ä¸²è¿›è¡Œæ•°å­¦è¿ç®—ï¼Œäº‹åŠ¡åœ¨é‡åˆ°æŒ‡ä»¤æ‰§è¡Œå¤±è´¥åï¼Œåé¢çš„æŒ‡ä»¤è¿˜ç»§ç»­æ‰§è¡Œï¼Œæ‰€ä»¥ poorman çš„å€¼èƒ½ç»§ç»­å¾—åˆ°è®¾ç½®ã€‚</p>
<p>åˆ°è¿™é‡Œï¼Œä½ åº”è¯¥æ˜ç™½ Redis çš„äº‹åŠ¡æ ¹æœ¬ä¸èƒ½ç®—ã€ŒåŸå­æ€§ã€ï¼Œè€Œä»…ä»…æ˜¯æ»¡è¶³äº†äº‹åŠ¡çš„ã€Œéš”ç¦»æ€§ã€ï¼Œéš”ç¦»æ€§ä¸­çš„ä¸²è¡ŒåŒ–â€”â€”å½“å‰æ‰§è¡Œçš„äº‹åŠ¡æœ‰ç€ä¸è¢«å…¶å®ƒäº‹åŠ¡æ‰“æ–­çš„æƒåˆ©ã€‚</p>

<hr />

<h4 id="discardä¸¢å¼ƒ">discardï¼ˆä¸¢å¼ƒï¼‰</h4>

<p>Redis ä¸ºäº‹åŠ¡æä¾›äº†ä¸€ä¸ª discard æŒ‡ä»¤ï¼Œç”¨äºä¸¢å¼ƒäº‹åŠ¡ç¼“å­˜é˜Ÿåˆ—ä¸­çš„æ‰€æœ‰æŒ‡ä»¤ï¼Œåœ¨ exec æ‰§è¡Œä¹‹å‰ã€‚</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">&gt;</span> <span class="n">get</span> <span class="nf">books</span>
<span class="o">(</span><span class="n">nil</span><span class="o">)</span>
<span class="o">&gt;</span> <span class="n">multi</span>
<span class="no">OK</span>
<span class="o">&gt;</span> <span class="n">incr</span> <span class="n">books</span>
<span class="no">QUEUED</span>
<span class="o">&gt;</span> <span class="n">incr</span> <span class="n">books</span>
<span class="no">QUEUED</span>
<span class="o">&gt;</span> <span class="n">discard</span>
<span class="no">OK</span>
<span class="o">&gt;</span> <span class="n">get</span> <span class="nf">books</span>
<span class="o">(</span><span class="n">nil</span><span class="o">)</span>
</code></pre></div></div>

<p>æˆ‘ä»¬å¯ä»¥çœ‹åˆ° discard ä¹‹åï¼Œé˜Ÿåˆ—ä¸­çš„æ‰€æœ‰æŒ‡ä»¤éƒ½æ²¡æ‰§è¡Œï¼Œå°±å¥½åƒ multi å’Œ discard ä¸­é—´çš„æ‰€æœ‰æŒ‡ä»¤ä»æœªå‘ç”Ÿè¿‡ä¸€æ ·</p>

<hr />

<h4 id="ä¼˜åŒ–">ä¼˜åŒ–</h4>

<p>ä¸Šé¢çš„ Redis äº‹åŠ¡åœ¨å‘é€æ¯ä¸ªæŒ‡ä»¤åˆ°äº‹åŠ¡ç¼“å­˜é˜Ÿåˆ—æ—¶éƒ½è¦ç»è¿‡ä¸€æ¬¡ç½‘ç»œè¯»å†™ï¼Œå½“ä¸€ä¸ªäº‹åŠ¡å†…éƒ¨çš„æŒ‡ä»¤è¾ƒå¤šæ—¶ï¼Œéœ€è¦çš„ç½‘ç»œ IO æ—¶é—´ä¹Ÿä¼šçº¿æ€§å¢é•¿ã€‚æ‰€ä»¥é€šå¸¸ Redis çš„å®¢æˆ·ç«¯åœ¨æ‰§è¡Œäº‹åŠ¡æ—¶éƒ½ä¼šç»“åˆ pipeline ä¸€èµ·ä½¿ç”¨ï¼Œè¿™æ ·å¯ä»¥å°†å¤šæ¬¡ IO æ“ä½œå‹ç¼©ä¸ºå•æ¬¡ IO æ“ä½œã€‚æ¯”å¦‚æˆ‘ä»¬åœ¨ä½¿ç”¨ Python çš„ Redis å®¢æˆ·ç«¯æ—¶æ‰§è¡Œäº‹åŠ¡æ—¶æ˜¯è¦å¼ºåˆ¶ä½¿ç”¨ pipeline çš„ã€‚</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">pipe</span> <span class="o">=</span> <span class="n">redis</span><span class="p">.</span><span class="n">pipeline</span><span class="p">(</span><span class="n">transaction</span><span class="o">=</span><span class="n">true</span><span class="p">)</span>
<span class="n">pipe</span><span class="p">.</span><span class="n">multi</span><span class="p">()</span>
<span class="n">pipe</span><span class="p">.</span><span class="n">incr</span><span class="p">(</span><span class="s">"books"</span><span class="p">)</span>
<span class="n">pipe</span><span class="p">.</span><span class="n">incr</span><span class="p">(</span><span class="s">"books"</span><span class="p">)</span>
<span class="n">values</span> <span class="o">=</span> <span class="n">pipe</span><span class="p">.</span><span class="n">execute</span><span class="p">()</span>
</code></pre></div></div>

<hr />

<h4 id="watch">Watch</h4>

<p>è€ƒè™‘åˆ°ä¸€ä¸ªä¸šåŠ¡åœºæ™¯ï¼ŒRedis å­˜å‚¨äº†æˆ‘ä»¬çš„è´¦æˆ·ä½™é¢æ•°æ®ï¼Œå®ƒæ˜¯ä¸€ä¸ªæ•´æ•°ã€‚ç°åœ¨æœ‰ä¸¤ä¸ªå¹¶å‘çš„å®¢æˆ·ç«¯è¦å¯¹è´¦æˆ·ä½™é¢è¿›è¡Œä¿®æ”¹æ“ä½œï¼Œè¿™ä¸ªä¿®æ”¹ä¸æ˜¯ä¸€ä¸ªç®€å•çš„ incrby æŒ‡ä»¤ï¼Œè€Œæ˜¯è¦å¯¹ä½™é¢ä¹˜ä»¥ä¸€ä¸ªå€æ•°ã€‚Redis å¯æ²¡æœ‰æä¾› multiplyby è¿™æ ·çš„æŒ‡ä»¤ã€‚æˆ‘ä»¬éœ€è¦å…ˆå–å‡ºä½™é¢ç„¶ååœ¨å†…å­˜é‡Œä¹˜ä»¥å€æ•°ï¼Œå†å°†ç»“æœå†™å› Redisã€‚</p>
<p>è¿™å°±ä¼šå‡ºç°å¹¶å‘é—®é¢˜ï¼Œå› ä¸ºæœ‰å¤šä¸ªå®¢æˆ·ç«¯ä¼šå¹¶å‘è¿›è¡Œæ“ä½œã€‚æˆ‘ä»¬å¯ä»¥é€šè¿‡ Redis çš„åˆ†å¸ƒå¼é”æ¥é¿å…å†²çªï¼Œè¿™æ˜¯ä¸€ä¸ªå¾ˆå¥½çš„è§£å†³æ–¹æ¡ˆã€‚<strong>åˆ†å¸ƒå¼é”æ˜¯ä¸€ç§æ‚²è§‚é”ï¼Œé‚£æ˜¯ä¸æ˜¯å¯ä»¥ä½¿ç”¨ä¹è§‚é”çš„æ–¹å¼æ¥è§£å†³å†²çªå‘¢ï¼Ÿ</strong></p>
<p>Redis æä¾›äº†è¿™ç§ watch çš„æœºåˆ¶ï¼Œå®ƒå°±æ˜¯ä¸€ç§ä¹è§‚é”ã€‚æœ‰äº† watch æˆ‘ä»¬åˆå¤šäº†ä¸€ç§å¯ä»¥
ç”¨æ¥è§£å†³å¹¶å‘ä¿®æ”¹çš„æ–¹æ³•ã€‚ watch çš„ä½¿ç”¨æ–¹å¼å¦‚ä¸‹ï¼š</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">while</span> <span class="nl">True:</span>
 <span class="n">do_watch</span><span class="o">()</span>
 <span class="n">commands</span><span class="o">()</span>
 <span class="n">multi</span><span class="o">()</span>
 <span class="n">send_commands</span><span class="o">()</span>
 <span class="k">try</span><span class="o">:</span>
 <span class="n">exec</span><span class="o">()</span>
 <span class="k">break</span>
 <span class="n">except</span> <span class="nl">WatchError:</span>
 <span class="k">continue</span>
</code></pre></div></div>

<p>watch ä¼šåœ¨äº‹åŠ¡å¼€å§‹ä¹‹å‰ç›¯ä½ 1 ä¸ªæˆ–å¤šä¸ªå…³é”®å˜é‡ï¼Œå½“äº‹åŠ¡æ‰§è¡Œæ—¶ï¼Œä¹Ÿå°±æ˜¯æœåŠ¡å™¨æ”¶åˆ°äº† exec æŒ‡ä»¤è¦é¡ºåºæ‰§è¡Œç¼“å­˜çš„äº‹åŠ¡é˜Ÿåˆ—æ—¶ï¼ŒRedis ä¼šæ£€æŸ¥å…³é”®å˜é‡è‡ª watch ä¹‹åï¼Œæ˜¯å¦è¢«ä¿®æ”¹äº† (åŒ…æ‹¬å½“å‰äº‹åŠ¡æ‰€åœ¨çš„å®¢æˆ·ç«¯)ã€‚å¦‚æœå…³é”®å˜é‡è¢«äººåŠ¨è¿‡äº†ï¼Œexec æŒ‡ä»¤å°±ä¼šè¿”å› null å›å¤å‘ŠçŸ¥å®¢æˆ·ç«¯äº‹åŠ¡æ‰§è¡Œå¤±è´¥ï¼Œè¿™ä¸ªæ—¶å€™å®¢æˆ·ç«¯ä¸€èˆ¬ä¼šé€‰æ‹©é‡è¯•ã€‚</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">&gt;</span> <span class="n">watch</span> <span class="n">books</span>
<span class="no">OK</span>
<span class="o">&gt;</span> <span class="n">incr</span> <span class="n">books</span> <span class="err">#</span> <span class="n">è¢«ä¿®æ”¹äº†</span>
<span class="o">(</span><span class="n">integer</span><span class="o">)</span> <span class="mi">1</span>
<span class="o">&gt;</span> <span class="n">multi</span>
<span class="no">OK</span>
<span class="o">&gt;</span> <span class="n">incr</span> <span class="n">books</span>
<span class="no">QUEUED</span>
<span class="o">&gt;</span> <span class="n">exec</span> <span class="err">#</span> <span class="n">äº‹åŠ¡æ‰§è¡Œå¤±è´¥</span>
<span class="o">(</span><span class="n">nil</span><span class="o">)</span>
</code></pre></div></div>

<p>å½“æœåŠ¡å™¨ç»™ exec æŒ‡ä»¤è¿”å›ä¸€ä¸ª null å›å¤æ—¶ï¼Œå®¢æˆ·ç«¯çŸ¥é“äº†äº‹åŠ¡æ‰§è¡Œæ˜¯å¤±è´¥çš„ï¼Œé€šå¸¸å®¢æˆ·ç«¯ (redis-py) éƒ½ä¼šæŠ›å‡ºä¸€ä¸ª WatchError è¿™ç§é”™è¯¯ï¼Œä¸è¿‡ä¹Ÿæœ‰äº›è¯­è¨€ (jedis) ä¸ä¼šæŠ›å‡ºå¼‚å¸¸ï¼Œè€Œæ˜¯é€šè¿‡åœ¨ exec æ–¹æ³•é‡Œè¿”å›ä¸€ä¸ª nullï¼Œè¿™æ ·å®¢æˆ·ç«¯éœ€è¦æ£€æŸ¥ä¸€ä¸‹è¿”å›ç»“æœæ˜¯å¦ä¸º null æ¥ç¡®å®šäº‹åŠ¡æ˜¯å¦æ‰§è¡Œå¤±è´¥ã€‚</p>
<p><strong>æ³¨æ„äº‹é¡¹</strong></p>
<p>Redis ç¦æ­¢åœ¨ multi å’Œ exec ä¹‹é—´æ‰§è¡Œ watch æŒ‡ä»¤ï¼Œè€Œå¿…é¡»åœ¨ multi ä¹‹å‰åšå¥½ç›¯ä½å…³é”®å˜é‡ï¼Œå¦åˆ™ä¼šå‡ºé”™ã€‚æ¥ä¸‹æ¥æˆ‘ä»¬ä½¿ç”¨ Python è¯­è¨€æ¥å®ç°å¯¹ä½™é¢çš„åŠ å€æ“ä½œã€‚</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># -*- coding: utf-8
</span><span class="kn">import</span> <span class="nn">redis</span>
<span class="k">def</span> <span class="nf">key_for</span><span class="p">(</span><span class="n">user_id</span><span class="p">):</span>
 <span class="k">return</span> <span class="s">"account_{}"</span><span class="p">.</span><span class="nb">format</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">double_account</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">user_id</span><span class="p">):</span>
 <span class="n">key</span> <span class="o">=</span> <span class="n">key_for</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span>
 <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
 <span class="n">client</span><span class="p">.</span><span class="n">watch</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
 <span class="n">value</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">client</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">))</span>
 <span class="n">value</span> <span class="o">*=</span> <span class="mi">2</span> <span class="c1"># åŠ å€
</span> <span class="n">pipe</span> <span class="o">=</span> <span class="n">client</span><span class="p">.</span><span class="n">pipeline</span><span class="p">(</span><span class="n">transaction</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
 <span class="n">pipe</span><span class="p">.</span><span class="n">multi</span><span class="p">()</span>
 <span class="n">pipe</span><span class="p">.</span><span class="nb">set</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
 <span class="k">try</span><span class="p">:</span>
 <span class="n">pipe</span><span class="p">.</span><span class="n">execute</span><span class="p">()</span>
 <span class="k">break</span> <span class="c1"># æ€»ç®—æˆåŠŸäº†
</span> <span class="k">except</span> <span class="n">redis</span><span class="p">.</span><span class="n">WatchError</span><span class="p">:</span>
 <span class="k">continue</span> <span class="c1"># äº‹åŠ¡è¢«æ‰“æ–­äº†ï¼Œé‡è¯•
</span> <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="n">client</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">))</span> <span class="c1"># é‡æ–°è·å–ä½™é¢
</span><span class="n">client</span> <span class="o">=</span> <span class="n">redis</span><span class="p">.</span><span class="n">StrictRedis</span><span class="p">()</span>
<span class="n">user_id</span> <span class="o">=</span> <span class="s">"abc"</span>
<span class="n">client</span><span class="p">.</span><span class="n">setnx</span><span class="p">(</span><span class="n">key_for</span><span class="p">(</span><span class="n">user_id</span><span class="p">),</span> <span class="mi">5</span><span class="p">)</span> <span class="c1"># setnx åšåˆå§‹åŒ–
</span><span class="k">print</span> <span class="n">double_account</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">user_id</span><span class="p">)</span>
</code></pre></div></div>

<p>ä¸‹é¢æˆ‘ä»¬å†ä½¿ç”¨ Java è¯­è¨€å®ç°ä¸€éã€‚
import java.util.List;
import redis.clients.jedis.Jedis;
import redis.clients.jedis.Transaction;
public class TransactionDemo {
Redis æ·±åº¦å†é™©ï¼šæ ¸å¿ƒåŸç†ä¸åº”ç”¨å®è·µ | é’±æ–‡å“ è‘— ç¬¬ 115 é¡µ å…± 226 é¡µ
 public static void main(String[] args) {
 Jedis jedis = new Jedis();
 String userId = "abc";
 String key = keyFor(userId);
 jedis.setnx(key, String.valueOf(5)); # setnx åšåˆå§‹åŒ–
 System.out.println(doubleAccount(jedis, userId));
 jedis.close();
 }
 public static int doubleAccount(Jedis jedis, String userId) {
 String key = keyFor(userId);
 while (true) {
 jedis.watch(key);
 int value = Integer.parseInt(jedis.get(key));
 value *= 2; // åŠ å€
 Transaction tx = jedis.multi();
 tx.set(key, String.valueOf(value));
 List<object> res = tx.exec();
 if (res != null) {
 break; // æˆåŠŸäº†
 }
 }
 return Integer.parseInt(jedis.get(key)); // é‡æ–°è·å–ä½™é¢
 }
 public static String keyFor(String userId) {
 return String.format("account_{}", userId);
 }
</object></p>
:ET